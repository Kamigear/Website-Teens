<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description"
        content="VDR Teens adalah komunitas remaja Buddhis untuk belajar Dhamma, puja bakti, dan bertumbuh bersama melalui kegiatan positif dan inspiratif ">
    <meta name="author" content="">
    <link rel="icon" type="image/png" href="images/web-logo.png">

    <title>Dashboard - VDR Teens</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@100;300;400;600;700&display=swap"
        rel="stylesheet">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-icons.css" rel="stylesheet">
    <link href="css/tooplate-gotto-job.css" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>


</head>

<body id="top">

    <nav class="navbar navbar-expand-xl fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <img src="images/logo.png" class="img-fluid logo-image" alt="Logo" loading="lazy">
                <div class="d-flex flex-column">
                    <strong class="logo-text">Teens</strong>
                    <small class="logo-small-text">Puja bakti Remaja</small>
                </div>
            </a>


            <div class="offcanvas offcanvas-end custom-offcanvas visible" tabindex="-1" id="offcanvasNavbar"
                aria-labelledby="offcanvasNavbarLabel" aria-modal="true" role="dialog">

                <div class="offcanvas-header">
                    <div class="d-flex align-items-center">
                        <img src="images/logo.png" class="img-fluid logo-image offcanvas-logo-img" loading="lazy">
                        <h5 class="offcanvas-title mb-0" id="offcanvasNavbarLabel">Menu</h5>
                    </div>
                </div>


                <div class="offcanvas-body d-flex flex-column">
                    <ul class="navbar-nav align-items-lg-center ms-lg-5 flex-grow-1 pe-3">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">Beranda</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="events.html">Kegiatan Teens</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="about.html">Tentang Teens</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="contact.html">Kontak</a>
                        </li>
                    </ul>

                    <div class="mt-auto mb-4 d-lg-none w-100 mobile-auth-section" id="mobileAuthSection">
                        <div class="d-grid gap-3">
                            <div class="btn-skeleton-mobile"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-none d-xl-flex align-items-center ms-xl-auto" id="desktopAuthContainer">
                <div class="btn-skeleton"></div>
            </div>
        </div>
    </nav>

    <!-- MOBILE BOTTOM NAVIGATION -->
    <nav class="mobile-bottom-nav d-flex d-xl-none">
        <a href="index.html"
            class="mobile-nav-item d-flex flex-column align-items-center justify-content-center text-decoration-none">
            <i class="bi-house-fill"></i>
            <span>Home</span>
        </a>
        <a href="dashboard.html"
            class="mobile-nav-item active d-flex flex-column align-items-center justify-content-center text-decoration-none">
            <i class="bi-grid"></i>
            <span>Dashboard</span>
        </a>
        <a href="events.html"
            class="mobile-nav-item d-flex flex-column align-items-center justify-content-center text-decoration-none">
            <i class="bi-calendar-event"></i>
            <span>Kegiatan</span>
        </a>
        <a href="#"
            class="mobile-nav-item d-flex flex-column align-items-center justify-content-center text-decoration-none"
            data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar">
            <i class="bi-list"></i>
            <span>Menu</span>
        </a>
    </nav>

    <main>
        <section class="section-padding bg-pure-white">
            <div class="container">
                <!-- User Dashboard -->
                <div id="user-dashboard">
                    <div class="row">
                        <div class="col-12 mb-4">
                            <h2>Halo, <span class="user-name text-primary-var">User</span>!</h2>
                            <p class="text-muted">Selamat datang kembali di dashboard point kamu.</p>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Point Balance -->
                        <div class="col-lg-4 col-12 mb-4">
                            <div class="dashboard-card h-100 text-center d-flex flex-column justify-content-center">
                                <div class="card-skeleton"></div>
                                <div class="card-content">
                                    <h3 class="dashboard-stat-title text-center fw-normal mb-3">Point Kebajikan</h3>
                                    <div class="dashboard-stat-value fw-bold lh-1" id="userPointBalance">
                                        0
                                    </div>
                                    <small class="text-muted mt-2">Points Anda</small>
                                </div>
                            </div>
                        </div>
                        <!-- Email Status Card -->
                        <div class="col-lg-4 col-12 mb-4">
                            <div class="dashboard-card h-100">
                                <div class="card-skeleton"></div>
                                <div class="card-content">
                                    <div class="d-flex mb-3">
                                        <div
                                            class="icon-box me-3 d-flex align-items-center justify-content-center rounded-circle">
                                            <i class="bi-envelope"></i>
                                        </div>
                                        <div>
                                            <h5 class="mb-0">Status Email</h5>
                                            <small class="text-muted">Koneksi akun</small>
                                        </div>
                                    </div>

                                    <div id="emailStatusContent">
                                        <!-- Note: Inner skeletons removed as we use full card skeleton now -->
                                        <div id="emailNotLinked" class="d-none">
                                            <div class="alert alert-warning mb-3 small alert-warning-custom">
                                                <i class="bi-exclamation-triangle me-2"></i>
                                                Belum terhubung
                                            </div>
                                            <p class="text-muted small mb-3">Hubungkan email untuk reset password &
                                                keamanan.</p>
                                            <button class="custom-btn btn-sm w-100 border-0" data-bs-toggle="modal"
                                                data-bs-target="#linkEmailModal">
                                                Hubungkan Email
                                            </button>
                                        </div>

                                        <div id="emailVerificationPending" class="d-none">
                                            <div class="alert alert-info mb-3 small">
                                                <i class="bi-hourglass-split me-2"></i>
                                                Menunggu Verifikasi
                                            </div>
                                            <div class="mb-2">
                                                <small class="text-muted">Email:</small>
                                                <p class="mb-0 fw-bold small text-break" id="pendingEmailDisplay">-</p>
                                            </div>
                                            <p class="text-muted small mb-2">Cek inbox/spam email Anda untuk
                                                memverifikasi
                                                akun.</p>

                                            <button class="btn btn-sm btn-primary p-1 px-2 text-decoration-none mb-3"
                                                onclick="resendVerificationEmail()">Kirim Ulang Link</button>

                                            <button class="btn btn-outline-secondary btn-sm w-100"
                                                data-bs-toggle="modal" data-bs-target="#unlinkEmailModal">
                                                Batalkan / Putuskan
                                            </button>
                                        </div>

                                        <div id="emailLinked" class="d-none">
                                            <div class="alert alert-success mb-3 small alert-success-custom">
                                                <i class="bi-check-circle me-2"></i>
                                                Terhubung
                                            </div>
                                            <div class="mb-2">
                                                <small class="text-muted">Email:</small>
                                                <p class="mb-0 fw-bold small text-break" id="linkedEmailDisplay">-</p>
                                            </div>
                                            <button class="btn btn-outline-secondary btn-sm w-100 mt-2"
                                                data-bs-toggle="modal" data-bs-target="#unlinkEmailModal"
                                                id="unlinkEmailBtn">
                                                Putuskan Koneksi
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- My QR & Code -->
                        <div class="col-lg-4 col-12 mb-4">
                            <div class="dashboard-card h-100 d-flex flex-column justify-content-center text-center">
                                <div class="card-skeleton"></div>
                                <div class="card-content">
                                    <div class="mb-3">
                                        <i class="bi-qr-code fs-3rem text-primary-var"></i>
                                    </div>
                                    <button class="btn custom-btn mb-3" data-bs-toggle="modal"
                                        data-bs-target="#qrModal">Tampilkan QR Saya</button>
                                    <hr class="border-color-var">
                                    <div class="input-group mt-2">
                                        <input type="text" class="form-control" id="codeInput"
                                            placeholder="Masukkan CODE Event" aria-label="My Code">
                                        <button class="btn custom-btn" type="button" id="submitCodeBtn">Submit</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Attendance Chart -->
                        <div class="col-lg-4 col-12 mb-4">
                            <div class="dashboard-card">
                                <div class="card-skeleton"></div>
                                <div class="card-content">
                                    <div class="d-flex justify-content-between align-items-center mb-4">
                                        <h5 class="mb-0">Statistik Kehadiran</h5>
                                        <select class="form-select form-select-sm w-auto border-secondary"
                                            id="chartFilter">
                                            <option value="1y">1 Tahun Terakhir</option>
                                            <option value="6m">6 Bulan Terakhir</option>
                                            <option value="3m">3 Bulan Terakhir</option>
                                            <option value="1m">1 Bulan Terakhir</option>
                                        </select>
                                    </div>
                                    <div id="chartContainer" class="chart-container-wrapper">
                                        <canvas id="userPointsChart" width="400" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="dashboard-card">
                                <div class="card-skeleton"></div>
                                <div class="card-content">
                                    <h4 class="mb-4">Riwayat Point</h4>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Tanggal</th>
                                                    <th>Kegiatan</th>
                                                    <th>Tipe</th>
                                                    <th>Point</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="pointHistoryTable">
                                                <!-- Content populated by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Dashboard (Hidden by default) -->
                <div id="admin-dashboard" class="d-none">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h2 class="mb-2">Admin <span class="text-second-white">Dashboard</span></h2>
                            <p class="text-muted">Manage users, events, and points system.</p>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Admin Actions -->
                        <div class="col-lg-4 mb-4">
                            <div class="dashboard-card h-100">
                                <div class="d-flex align-items-center mb-3">
                                    <div
                                        class="icon-box me-3 d-flex align-items-center justify-content-center rounded-circle">
                                        <i class="bi-people"></i>
                                    </div>
                                    <h5 class="mb-0">Kelola Akun</h5>
                                </div>
                                <p class="text-muted small">Buat, edit, atau hapus akun member.</p>
                                <div class="d-flex gap-2 mt-auto">
                                    <button class="btn btn-outline-dark btn-sm flex-grow-1" data-bs-toggle="modal"
                                        data-bs-target="#manageAccountsModal">Lihat Semua</button>
                                    <button class="custom-btn btn-sm flex-grow-1" onclick="addNewAccount()">Buat
                                        Akun</button>
                                </div>
                            </div>
                        </div>

                        <!-- Kelola Kegiatan -->
                        <div class="col-lg-4 mb-4">
                            <div class="dashboard-card h-100">
                                <div class="d-flex align-items-center mb-3">
                                    <div
                                        class="icon-box me-3 d-flex align-items-center justify-content-center rounded-circle">
                                        <i class="bi-calendar-event"></i>
                                    </div>
                                    <h5 class="mb-0">Kelola Kegiatan</h5>
                                </div>
                                <p class="text-muted small">Buat, edit, atau hapus kegiatan Teens.</p>
                                <div class="d-flex gap-2 mt-auto">
                                    <button class="btn btn-outline-dark btn-sm flex-grow-1" data-bs-toggle="modal"
                                        data-bs-target="#manageEventsModal">Lihat Semua</button>
                                    <button class="custom-btn btn-sm flex-grow-1" data-bs-toggle="modal"
                                        data-bs-target="#addEventModal">Buat Event</button>
                                </div>
                            </div>
                        </div>

                        <!-- Scan User QR Action -->
                        <div class="col-lg-4 mb-4">
                            <div class="dashboard-card h-100">
                                <div class="d-flex align-items-center mb-3">
                                    <div
                                        class="icon-box me-3 d-flex align-items-center justify-content-center rounded-circle">
                                        <i class="bi-qr-code-scan"></i>
                                    </div>
                                    <h5 class="mb-0">Scan & Beri Point</h5>
                                </div>
                                <p class="text-muted small">Scan QR Code member untuk memberikan poin langsung.</p>
                                <button class="btn custom-btn btn-sm w-100 mt-auto" onclick="startAdminScanner()">
                                    <i class="bi-camera-fill me-2"></i>Mulai Scan
                                </button>
                            </div>
                        </div>


                        <div class="col-lg-4 mb-4">
                            <div class="dashboard-card h-100 bg-primary-var text-white-var">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi-clock-history fs-1 me-3 text-secondary-var"></i>
                                    <h5 class="mb-0 text-white">Token Mingguan</h5>
                                </div>
                                <p class="small text-secondary-var">Tampilkan kode token mingguan
                                    layar penuh.</p>

                                <div class="d-none"> <!-- Hidden elements for state management -->
                                    <span id="weeklyCodeDisplay">-----</span>
                                    <span id="weeklyCodeTimer">30s</span>
                                </div>

                                <button type="button" class="btn btn-light w-100 mt-auto text-primary-var"
                                    onclick="generateAndShowToken()">Munculkan
                                    Token</button>
                            </div>
                        </div>

                        <div class="col-lg-4 mb-4">
                            <div class="dashboard-card h-100">
                                <div class="d-flex align-items-center mb-3">
                                    <div
                                        class="icon-box me-3 d-flex align-items-center justify-content-center rounded-circle">
                                        <i class="bi-sliders"></i>
                                    </div>
                                    <h5 class="mb-0">Aturan Poin</h5>
                                </div>
                                <p class="text-muted small">Atur jadwal dan poin kehadiran.</p>
                                <button class="btn btn-outline-dark btn-sm w-100 mt-auto" data-bs-toggle="modal"
                                    data-bs-target="#attendanceConfigModal">Konfigurasi</button>
                            </div>
                        </div>

                        <!-- Export UserData Card -->
                        <div class="col-lg-4 mb-4">
                            <div class="dashboard-card h-100">
                                <div class="d-flex align-items-center mb-3">
                                    <div
                                        class="icon-box me-3 d-flex align-items-center justify-content-center rounded-circle">
                                        <i class="bi-people-fill"></i>
                                    </div>
                                    <h5 class="mb-0">Export User Data</h5>
                                </div>
                                <p class="text-muted small">Backup semua data user ke Google Sheets.</p>
                                <button class="btn custom-btn btn-sm w-100 mt-auto" onclick="exportUserDataToSheets()">
                                    <i class="bi-cloud-upload me-2"></i>Export Users
                                </button>
                            </div>
                        </div>

                        <!-- Export ServerData Card -->
                        <div class="col-lg-4 mb-4">
                            <div class="dashboard-card h-100">
                                <div class="d-flex align-items-center mb-3">
                                    <div
                                        class="icon-box me-3 d-flex align-items-center justify-content-center rounded-circle">
                                        <i class="bi-server"></i>
                                    </div>
                                    <h5 class="mb-0">Export Server Data</h5>
                                </div>
                                <p class="text-muted small">Backup konfigurasi server ke Google Sheets.</p>
                                <button class="btn custom-btn btn-sm w-100 mt-auto"
                                    onclick="exportServerDataToSheets()">
                                    <i class="bi-cloud-upload me-2"></i>Export Settings
                                </button>
                            </div>
                        </div>

                        <!-- Import UserData Card -->
                        <div class="col-lg-4 mb-4">
                            <div class="dashboard-card h-100">
                                <div class="d-flex align-items-center mb-3">
                                    <div
                                        class="icon-box me-3 d-flex align-items-center justify-content-center rounded-circle">
                                        <i class="bi-cloud-download-fill"></i>
                                    </div>
                                    <h5 class="mb-0">Import User Data</h5>
                                </div>
                                <p class="text-muted small">Restore data user dari Google Sheets ke Firestore.</p>
                                <button type="button" class="btn custom-btn btn-sm w-100 mt-auto"
                                    onclick="importUserDataFromSheets()">
                                    <i class="bi-cloud-download me-2"></i>Import Users
                                </button>
                            </div>
                        </div>

                        <!-- Import ServerData Card -->
                        <div class="col-lg-4 mb-4">
                            <div class="dashboard-card h-100">
                                <div class="d-flex align-items-center mb-3">
                                    <div
                                        class="icon-box me-3 d-flex align-items-center justify-content-center rounded-circle">
                                        <i class="bi-database-fill-down"></i>
                                    </div>
                                    <h5 class="mb-0">Import Server Data</h5>
                                </div>
                                <p class="text-muted small">Restore konfigurasi server dari Google Sheets ke Firestore.
                                </p>
                                <button type="button" class="btn custom-btn btn-sm w-100 mt-auto"
                                    onclick="importServerDataFromSheets()">
                                    <i class="bi-cloud-download me-2"></i>Import Settings
                                </button>
                            </div>
                        </div>

                        <div class="col-12 mb-4">
                            <div class="dashboard-card">
                                <h5 class="mb-3">Buat Kode Event Unik</h5>
                                <form class="row g-3">
                                    <div class="col-lg-6">
                                        <input type="text" class="form-control"
                                            placeholder="Kode (opsional, kosongkan untuk auto-generate)"
                                            id="eventNameInput">
                                    </div>
                                    <div class="col-lg-4">
                                        <input type="number" class="form-control" placeholder="Jumlah Point"
                                            id="pointsInput" min="1">
                                    </div>
                                    <div class="col-lg-2">
                                        <button type="button" class="btn custom-btn w-100"
                                            onclick="generateCustomCode()">Generate</button>
                                    </div>
                                </form>
                                <div class="mt-4">
                                    <h6 class="mb-3">Daftar Kode Aktif</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover" id="activeCodesTable">
                                            <thead>
                                                <tr>
                                                    <th>Kode</th>
                                                    <th>Tipe</th>
                                                    <th>Status</th>
                                                    <th>Point</th>
                                                    <th>Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Skeleton Rows -->
                                                <tr class="skeleton-row placeholder-glow">
                                                    <td><span class="placeholder col-6"></span></td>
                                                    <td><span class="placeholder col-4"></span></td>
                                                    <td><span class="placeholder col-4"></span></td>
                                                    <td><span class="placeholder col-2"></span></td>
                                                    <td><span class="placeholder col-2"></span></td>
                                                </tr>
                                                <tr class="skeleton-row placeholder-glow">
                                                    <td><span class="placeholder col-5"></span></td>
                                                    <td><span class="placeholder col-4"></span></td>
                                                    <td><span class="placeholder col-4"></span></td>
                                                    <td><span class="placeholder col-2"></span></td>
                                                    <td><span class="placeholder col-2"></span></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- TOAST CONTAINER (REPLACES ALERTS) -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                Message goes here.
            </div>
        </div>
    </div>

    <footer class="site-footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 col-12 mb-3">
                    <div class="d-flex align-items-center mb-4">
                        <img src="images/logo.png" class="img-fluid logo-image" loading="lazy">
                        <div class="d-flex flex-column">
                            <strong class="logo-text">Teens</strong>
                            <small class="logo-small-text">Puja bakti Remaja</small>
                        </div>
                    </div>

                    <p class="mb-2">
                        <i class="custom-icon bi-globe me-1"></i>
                        <a href="https://teens-vdr.web.app/" class="site-footer-link">
                            https://teens-vdr.web.app/
                        </a>
                    </p>


                    <p class="mb-2">
                        <i class="custom-icon bi-envelope me-1"></i>
                        <a href="mailto:teensfordhamma@gmail.com" class="site-footer-link">
                            teensfordhamma@gmail.com
                        </a>
                    </p>

                    <p class="mb-2">
                        <i class="custom-icon bi-whatsapp me-1"></i>
                        <a href="https://chat.whatsapp.com/KUdvHjj8Ipz6JfiHgXWaGQ?mode=hqrt3" class="site-footer-link">
                            Grup WhatsApp
                        </a>
                    </p>

                    <p class="mb-2">
                        <i class="custom-icon bi-instagram me-1"></i>
                        <a href="https://www.instagram.com/vdrteens/" class="site-footer-link">
                            @vdrteens
                        </a>
                    </p>
                </div>

                <div class="col-lg-4 col-12 mt-3 mt-lg-0 ms-auto">
                    <h6 class="site-footer-title">Kontak Email Langsung</h6>
                    <form class="custom-form newsletter-form"
                        onclick="window.location.href='mailto:teensfordhamma@gmail.com'" method="post" role="form">
                        <div class="input-group">
                            <span class="input-group-text" id="basic-addon1"><i class="bi-person"></i></span>
                            <input type="text" name="newsletter-name" id="newsletter-name" class="form-control"
                                placeholder="emailmu@gmail.com" required>
                            <button type="submit" class="form-control">
                                <i class="bi-send"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="site-footer-bottom">
            <div class="container">
                <div class="row align-items-center">


                    <div class="col-lg-4 col-12 d-flex justify-content-start mb-3 mb-lg-0">
                        <p class="mb-0">
                            Design & Script:
                            <a class="sponsored-link" rel="sponsored" target="_blank">
                                Richie Leonardo Cendana
                            </a>
                        </p>
                    </div>


                    <div class="col-lg-3 col-12 d-flex justify-content-lg-end justify-content-center">
                        <a href="#top"
                            class="back-top-icon bi-arrow-up smoothscroll d-flex justify-content-center align-items-center">
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- MODALS -->

    <!-- Qr Modal (User Side) -->
    <div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-4">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h4 class="mb-4">QR Code Saya</h4>
                    <img id="myQrImage" src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=Loading"
                        class="img-fluid mb-3" alt="QR Code" loading="lazy">
                    <p class="text-muted">Tunjukkan QR ini kepada Admin untuk discan.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Scan QR Modal -->
    <div class="modal fade" id="adminScanModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Scan User QR</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                        onclick="stopScannerLabel()"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="reader" width="100%"></div>
                    <p class="mt-3 text-muted">Arahkan kamera ke QR Code User</p>
                </div>
            </div>
        </div>
    </div>

    <!-- SCANNER RESULT MODAL (NEW REPLACEMENT FOR PROMPT) -->
    <div class="modal fade" id="scanResultModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-secondary-theme">
                    <h5 class="modal-title">Hasil Scan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="scannedUserId">
                    <div class="mb-3 text-center">
                        <h6>User Ditemukan:</h6>
                        <h4 id="scannedUserName" class="text-primary">User</h4>
                    </div>

                    <form id="scanResultForm">
                        <div class="mb-3">
                            <label class="form-label">Jumlah Point</label>
                            <input type="number" class="form-control" id="scanPointsInput" value="10" required>
                            <div class="form-text">Gunakan negatif (contoh: -5) untuk mengurangi.</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Keterangan / Alasan</label>
                            <input type="text" class="form-control" id="scanDescInput"
                                value="Diberikan oleh Admin (Scan QR)" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn custom-btn" onclick="submitScanResult()">Proses</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Manage Accounts Modal -->
    <div class="modal fade" id="manageAccountsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Kelola Akun</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-end mb-3">
                        <button class="btn custom-btn btn-sm" onclick="addNewAccount()"><i
                                class="bi-plus-circle me-2"></i>Tambah Akun</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Nama</th>
                                    <th>Email</th>
                                    <th>Point</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="accountsTableBody">
                                <!-- Skeleton Rows -->
                                <tr class="skeleton-row placeholder-glow">
                                    <td><span class="placeholder col-6"></span></td>
                                    <td><span class="placeholder col-8"></span></td>
                                    <td><span class="placeholder col-2"></span></td>
                                    <td><span class="placeholder col-4"></span></td>
                                </tr>
                                <tr class="skeleton-row placeholder-glow">
                                    <td><span class="placeholder col-5"></span></td>
                                    <td><span class="placeholder col-7"></span></td>
                                    <td><span class="placeholder col-2"></span></td>
                                    <td><span class="placeholder col-4"></span></td>
                                </tr>
                                <tr class="skeleton-row placeholder-glow">
                                    <td><span class="placeholder col-6"></span></td>
                                    <td><span class="placeholder col-7"></span></td>
                                    <td><span class="placeholder col-2"></span></td>
                                    <td><span class="placeholder col-4"></span></td>
                                </tr>
                                <tr class="skeleton-row placeholder-glow">
                                    <td><span class="placeholder col-5"></span></td>
                                    <td><span class="placeholder col-8"></span></td>
                                    <td><span class="placeholder col-2"></span></td>
                                    <td><span class="placeholder col-4"></span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Config Modal -->
    <div class="modal fade" id="attendanceConfigModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Konfigurasi Poin Absensi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="attendanceConfigForm">
                        <div class="mb-3 p-3 rounded border bg-white-var">
                            <h6 class="mb-3">Slot Waktu 1 (Tepat Waktu)</h6>
                            <div class="row g-2 align-items-center">
                                <div class="col-auto">Sampai jam:</div>
                                <div class="col"><input type="time" class="form-control" id="slot1Time" required
                                        value="09:05"></div>
                                <div class="col-auto">Point:</div>
                                <div class="col"><input type="number" class="form-control" id="slot1Points" required
                                        value="3"></div>
                            </div>
                        </div>

                        <div class="mb-3 p-3 rounded border bg-white-var"> <!-- Updated -->
                            <h6 class="mb-3">Slot Waktu 2 (Terlambat)</h6>
                            <div class="row g-2 align-items-center">
                                <div class="col-auto">Sampai jam:</div>
                                <div class="col"><input type="time" class="form-control" id="slot2Time" required
                                        value="09:20"></div>
                                <div class="col-auto">Point:</div>
                                <div class="col"><input type="number" class="form-control" id="slot2Points" required
                                        value="2"></div>
                            </div>
                        </div>

                        <div class="mb-3 p-3 rounded border bg-white-var">
                            <h6 class="mb-3">Lewat dari itu</h6>
                            <div class="row g-2 align-items-center">
                                <div class="col-auto">Dapat Poin:</div>
                                <div class="col"><input type="number" class="form-control" id="defaultPoints" required
                                        value="0"></div>
                            </div>
                        </div>

                        <div class="mb-3 p-3 rounded border bg-white-var">
                            <h6 class="mb-3">Pengaturan Token</h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="small text-muted">Refresh (detik)</label>
                                    <input type="number" class="form-control" id="tokenInterval" required value="30">
                                </div>
                                <div class="col-6">
                                    <label class="small text-muted">Masa Aktif (menit)</label>
                                    <input type="number" class="form-control" id="tokenValidity" required value="5">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn custom-btn" onclick="saveAttendanceConfig()">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Token Overlay -->
    <div id="tokenOverlay"
        class="d-none position-fixed top-0 start-0 w-100 h-100 flex-column justify-content-center align-items-center token-overlay-fullscreen">
        <button class="btn btn-outline-dark position-absolute top-0 start-0 m-4" onclick="closeTokenOverlay()">
            <i class="bi-arrow-left me-2"></i>Kembali
        </button>
        <h2 class="mb-4 text-primary-var">Kode Mingguan:</h2>
        <h1 class="display-1 fw-bold mb-5 text-primary-var" id="tokenDisplayValue">CODE</h1>
        <div class="text-center">
            <h3 class="mb-3 text-p-color">Token Valid Untuk:</h3>
            <div class="display-4 fw-bold text-custom-btn" id="tokenTimer">60</div>
            <small class="text-muted">Detik</small>
        </div>
    </div>

    <!-- Link Email Modal -->
    <div class="modal fade" id="linkEmailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 bg-secondary-theme">
                    <h5 class="modal-title">Hubungkan Email</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="linkEmailForm">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="linkEmailInput" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Konfirmasi Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="confirmPasswordInput" required>
                                <button class="btn btn-outline-secondary" type="button"
                                    onclick="togglePassword('confirmPasswordInput', 'icon-confirmPassword')">
                                    <i class="bi bi-eye" id="icon-confirmPassword"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn custom-btn" id="submitLinkEmail">Hubungkan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Unlink Email Modal (Confirmation) -->
    <div class="modal fade" id="unlinkEmailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 bg-danger text-white">
                    <h5 class="modal-title">Putuskan Koneksi Email?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-3">
                        Akun Anda akan dikembalikan ke mode tanpa email (dummy).
                        Anda akan login menggunakan <b>Username</b> setelah ini.
                    </p>
                    <form id="unlinkEmailForm">
                        <div class="mb-3">
                            <label class="form-label">Masukkan Password untuk Verifikasi</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="unlinkConfirmPasswordInput" required>
                                <button class="btn btn-outline-secondary" type="button"
                                    onclick="togglePassword('unlinkConfirmPasswordInput', 'icon-unlinkPassword')">
                                    <i class="bi bi-eye" id="icon-unlinkPassword"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger" id="submitUnlinkEmail">Putuskan Koneksi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Confirmation Modal -->
    <div class="modal fade" id="exportConfirmModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 bg-secondary-theme">
                    <h5 class="modal-title">
                        <i class="bi-exclamation-triangle-fill me-2"></i>Konfirmasi Export
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning-custom">
                        <strong>Perhatian!</strong> Anda akan mengexport data ke Google Sheets.
                    </div>

                    <p class="text-muted small mb-3" id="exportModalMessage">
                        Data akan dikirim ke spreadsheet backup.
                    </p>

                    <!-- 10-Click Confirmation -->
                    <div class="mb-3 text-center">
                        <p class="small text-muted mb-2">Klik tombol di bawah <strong id="clickCountDisplay">10</strong>
                            kali untuk konfirmasi:</p>
                        <button type="button" class="btn custom-border-btn btn-lg" id="confirmClickBtn"
                            onclick="handleConfirmClick()">
                            <i class="bi-hand-index-thumb"></i> Klik Saya (<span id="clickCounter">0</span>/10)
                        </button>
                    </div>

                    <form id="exportPasswordForm" onsubmit="return false;">
                        <div class="mb-3">
                            <label class="form-label">Masukkan Password Admin:</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="exportPasswordInput"
                                    placeholder="Password" required disabled>
                                <button class="btn btn-outline-dark" type="button" disabled
                                    onclick="togglePassword('exportPasswordInput', 'icon-exportPassword')">
                                    <i class="bi bi-eye" id="icon-exportPassword"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal"
                        onclick="resetExportModal()">Batal</button>
                    <button type="button" class="btn custom-btn" id="submitExportBtn" disabled onclick="submitExport()">
                        <i class="bi-cloud-upload me-2"></i>Export Sekarang
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Confirmation Modal -->
    <div class="modal fade" id="importConfirmModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 bg-secondary-theme">
                    <h5 class="modal-title">
                        <i class="bi-exclamation-triangle-fill me-2"></i>Konfirmasi Import
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning-custom">
                        <strong>Perhatian!</strong> Anda akan mengimport data dari Google Sheets ke Firestore.
                    </div>

                    <p class="text-muted small mb-3" id="importModalMessage">
                        Data dari spreadsheet akan ditambahkan/diupdate ke Firestore.
                    </p>

                    <!-- 10-Click Confirmation -->
                    <div class="mb-3 text-center">
                        <p class="small text-muted mb-2">Klik tombol di bawah <strong
                                id="importClickCountDisplay">10</strong>
                            kali untuk konfirmasi:</p>
                        <button type="button" class="btn custom-border-btn btn-lg" id="importConfirmClickBtn"
                            onclick="handleImportConfirmClick()">
                            <i class="bi-hand-index-thumb"></i> Klik Saya (<span id="importClickCounter">0</span>/10)
                        </button>
                    </div>

                    <form id="importPasswordForm" onsubmit="return false;">
                        <div class="mb-3">
                            <label class="form-label">Masukkan Password Admin:</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="importPasswordInput"
                                    placeholder="Password" required disabled>
                                <button class="btn btn-outline-dark" type="button" disabled
                                    onclick="togglePassword('importPasswordInput', 'icon-importPassword')">
                                    <i class="bi bi-eye" id="icon-importPassword"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal"
                        onclick="resetImportModal()">Batal</button>
                    <button type="button" class="btn custom-btn" id="submitImportBtn" disabled onclick="submitImport()">
                        <i class="bi-cloud-download me-2"></i>Import Sekarang
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <div id="dynamicFormFields"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn custom-btn" onclick="saveUserChanges()">Update Firebase</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Events Modal -->
    <div class="modal fade" id="manageEventsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Kelola Kegiatan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-end mb-3">
                        <button class="btn custom-btn btn-sm" data-bs-toggle="modal" data-bs-target="#addEventModal">
                            <i class="bi-plus-circle me-2"></i>Tambah Kegiatan
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Judul</th>
                                    <th>Tanggal</th>
                                    <th>Lokasi</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="eventsTableBody">
                                <!-- Skeleton Rows -->
                                <tr class="skeleton-row placeholder-glow">
                                    <td><span class="placeholder col-6"></span></td>
                                    <td><span class="placeholder col-4"></span></td>
                                    <td><span class="placeholder col-5"></span></td>
                                    <td><span class="placeholder col-3"></span></td>
                                    <td><span class="placeholder col-3"></span></td>
                                </tr>
                                <tr class="skeleton-row placeholder-glow">
                                    <td><span class="placeholder col-5"></span></td>
                                    <td><span class="placeholder col-4"></span></td>
                                    <td><span class="placeholder col-5"></span></td>
                                    <td><span class="placeholder col-3"></span></td>
                                    <td><span class="placeholder col-3"></span></td>
                                </tr>
                                <tr class="skeleton-row placeholder-glow">
                                    <td><span class="placeholder col-7"></span></td>
                                    <td><span class="placeholder col-4"></span></td>
                                    <td><span class="placeholder col-5"></span></td>
                                    <td><span class="placeholder col-3"></span></td>
                                    <td><span class="placeholder col-3"></span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Event Modal -->
    <div class="modal fade" id="addEventModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalTitle">Tambah Kegiatan Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="eventForm">
                        <input type="hidden" id="eventId">

                        <!-- Event Title -->
                        <div class="mb-3">
                            <label for="eventTitle" class="form-label">Judul Kegiatan <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="eventTitle" required>
                        </div>

                        <!-- Event Description -->
                        <div class="mb-3">
                            <label for="eventDescription" class="form-label">Deskripsi <span
                                    class="text-danger">*</span></label>
                            <textarea class="form-control" id="eventDescription" rows="3" required></textarea>
                        </div>

                        <!-- Event Type -->
                        <div class="mb-3">
                            <label for="eventType" class="form-label">Tipe Kegiatan <span
                                    class="text-danger">*</span></label>
                            <select class="form-select" id="eventType" required>
                                <option value="">Pilih Tipe</option>
                                <option value="featured">Event Utama</option>
                                <option value="regular">Event Reguler</option>
                            </select>
                        </div>

                        <!-- Date and Time -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="eventDate" class="form-label">Tanggal <span
                                        class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="eventDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="eventTime" class="form-label">Waktu <span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="eventTime" placeholder="08:00 - 20:00 WIB"
                                    required>
                            </div>
                        </div>

                        <!-- Location -->
                        <div class="mb-3">
                            <label for="eventLocation" class="form-label">Lokasi <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="eventLocation" required>
                        </div>

                        <!-- Image URL -->
                        <div class="mb-3">
                            <label class="form-label">Gambar Kegiatan</label>

                            <!-- File Upload Option -->
                            <div class="input-group mb-2">
                                <input type="file" class="form-control" id="eventImageFile" accept="image/*">
                            </div>
                            <small class="text-muted d-block mb-2">Upload gambar dari komputer Anda (Max 2MB)</small>

                            <div class="text-center my-2 text-muted">- ATAU -</div>

                            <label for="eventImage" class="form-label">URL Gambar Eksternal</label>

                            <input type="url" class="form-control" id="eventImage"
                                placeholder="https://example.com/image.jpg">
                            <small class="text-muted">Opsional. Kosongkan untuk menggunakan gambar default.</small>
                        </div>

                        <!-- Category/Badge -->
                        <div class="mb-3">
                            <label for="eventCategory" class="form-label">Kategori/Badge</label>
                            <input type="text" class="form-control" id="eventCategory"
                                placeholder="RETREAT, MEDITASI, dll">
                        </div>

                        <!-- Action Button Settings -->
                        <div class="mb-3">
                            <label for="eventCategory" class="form-label">Tombol Aksi</label>
                        </div>
                        <div class="mb-3 p-3 bg-light rounded border">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enableActionButton"
                                    onchange="toggleActionButtonFields()">
                                <label class="form-check-label fw-bold" for="enableActionButton">Tambahkan Action Button
                                    (Opsional)</label>
                            </div>

                            <div id="actionButtonFields" class="d-none">
                                <div class="row g-2">
                                    <div class="col-md-5">
                                        <label class="form-label small">Teks Tombol</label>
                                        <input type="text" class="form-control form-control-sm" id="actionButtonText"
                                            placeholder="Contoh: Daftar Sekarang">
                                    </div>
                                    <div class="col-md-7">
                                        <label class="form-label small">Link URL</label>
                                        <input type="url" class="form-control form-control-sm" id="actionButtonLink"
                                            placeholder="https://forms.google.com/...">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Status -->
                        <div class="mb-3">
                            <label for="eventStatus" class="form-label">Status <span
                                    class="text-danger">*</span></label>
                            <select class="form-select" id="eventStatus" required>
                                <option value="upcoming">Akan Datang</option>
                                <option value="ongoing">Sedang Berlangsung</option>
                                <option value="completed">Selesai</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn custom-btn" onclick="saveEvent()">Simpan</button>
                </div>
            </div>
        </div>
    </div>




    <!-- TOAST CONTAINER for Unified Notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer" style="z-index: 10000;"></div>

    <script src="js/bootstrap.min.js"></script>


    <script src="js/mobile-nav-slide.js"></script>
    <script type="module" src="js/navbar-auth.js"></script>
    <script type="module" src="js/dashboard.js?v=2"></script>
</body>

</html>